<!DOCTYPE html> <!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]--> <!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]--> <!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html manifest="cache.manifest" class="no-js" lang="en"><!--<![endif]--> <head> <meta charset="utf-8"> <title>Creating an APT Repository - A personal Blog</title> <meta name="author" content="Manuel"> <meta name="keywords" content="2017, debian, bash, administration"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="apple-touch-icon" href="/style/touch-icon.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/style/touch-icon.png"> <link rel="canonical" href="https://manuel-io.github.io/blog/2017/07/09/creating-an-apt-repository"> <link rel="shortcut icon" type="image/png" href="/favicon.png"> <link href="/stylesheets/screen.css" media="all" rel="stylesheet" type="text/css"> <link href="/atom.xml" rel="alternate" title="A personal Blog" type="application/atom+xml"> <script src="/javascripts/libs/jquery-1.11.2.min.js" type="text/javascript"></script> <script src="/javascripts/blog.js" type="text/javascript"></script> <script type="text/javascript" src="/javascripts/mathjax/unpacked/MathJax.js?config=TeX-AMS_HTML"></script> <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "jax": ["input/TeX", "output/HTML-CSS"],
    styles: { ".MathJax_Display": { "text-align": "left" } },
    "tex2jax": {
      inlineMath: [ ['$', '$'], ["\\(", "\\)"] ],
      displayMath: [ ['$$', '$$'], ["\\[", "\\]"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: { autoNumber: "AMS" },
      TagSide: "left"
    },
    "HTML-CSS": {
      availableFonts: ["TeX"],
      linebreaks: { automatic: true }
    }
  });
</script> </head> <body> <header class='site'><h1> <a href="/"> <p>A</p> <p> </p> <p>p</p> <p>e</p> <p>r</p> <p>s</p> <p>o</p> <p>n</p> <p>a</p> <p>l</p> <p> </p> <p>B</p> <p>l</p> <p>o</p> <p>g</p> </a> </h1> </header> <div style='clear:both;'></div> <nav><span><a href="/">Blog</a></span> <span><a href="/blog/photography">Photography</a></span> <span><a href="http://vkitchen.herokuapp.com" target="_blank">Kitchen</a></span> <span><a href="https://github.com/manuel-io" target="_blank">Github</a></span> <span><a href="https://de.wikipedia.org/wiki/Benutzer:Manuel_Bieling" target="_blank">Wikipedia</a></span> <span><a href="/blog/links">Links</a></span> <span><a href="/atom.xml">Feed</a></span> <span><a href="/blog/tags">Tags</a></span> <span><a href="/blog/archives">Archive</a></span> <span><a href="/blog/about">About</a></span> </nav> <article> <header class='post'> <h1 class="entry-title">Creating an APT Repository</h1> <p> <time class='entry-date' datetime='2017-07-09T13:35:27+02:00'><span class='date'>Jul, 2017-07-09 | </span> <span class='time'>Sun, 13:35 </span></time> </p> </header> <section><figure class='img left'> <img src='/data/images/stretch.png' title='Debian 9.0 Stretch' alt='Debian 9.0 Stretch'> <figcaption>Debian 9.0 Stretch</figcaption> </figure> <p>While celebrating the release of <a href="https://bits.debian.org/2017/06/stretch-released.html">Debian Stretch</a> I decided to write a tutorial on how to create a local Debian Repository. This follows <a href="https://news.ycombinator.com/item?id=14579080">a huge discussion</a> about how to improve Debian in the future.</p> <p>My motivation is to build a Debian distribution based on my personalized settings which makes a re-installation much simpler and faster. For obvious reasons <a href="https://github.com/manuel-io/debian-install">this project</a> includes a local APT repository and makes a network connection unnecessary.</p> <p>Fortunately the Debian team has build some tools (<code>dpkg-scanpackages</code>, <code>apt-ftparchive</code>) to automate this process. Make sure you have the required tools installed (<code>sudo apt-get install dpkg-dev apt-utils gpg</code>). You will need a GPG key for signing. If you don&rsquo;t have an existing GPG key consider reading <a href="https://help.github.com/articles/generating-a-new-gpg-key/">this guide</a>.</p> <h3>1) Basic</h3> <pre><code>mkdir -p /repository/amd64
cd /repository/amd64
</code></pre> <p>Now download deb-files into this directory and execute some commands to build the repository:</p> <pre><code>dpkg-scanpackages -a amd64 . &gt; Packages
apt-ftparchive release . &gt; Release
gpg -a --yes --clearsign --output InRelease --local-user $(id -un) --detach-sign Release
</code></pre> <p>I&rsquo;ll give further explanations in the section about <a href="#apt">APT</a>. So read on.</p> <h3>2) Advanced</h3> <p>A more advanced example could be used together with <code>debootstrap</code>. First build the required directory structure and create a file for further configuration <code>release.conf</code>:</p> <pre><code>mkdir -p /repository/amd64/pool/main
mkdir -p /repository/amd64/dists/stable/main/binary-amd64

mkdir -p /repository/amd64/pool/contrib
mkdir -p /repository/amd64/dists/stable/contrib/binary-amd64

mkdir -p /repository/amd64/pool/non-free
mkdir -p /repository/amd64/dists/stable/non-free/binary-amd64

cd /repository/amd64

cat &gt; release.conf &lt;&lt;BLOCK
APT::FTPArchive::Release::Codename "stable";
APT::FTPArchive::Release::Components "main contrib non-free";
APT::FTPArchive::Release::Label "Local APT Repository";
APT::FTPArchive::Release::Architectures "amd64";
BLOCK
</code></pre> <p>Now download* deb-files into <code>pool/main</code>, <code>pool/contrib</code> and <code>pool/non-free</code> directories. Next use the <code>apt-ftparchive</code> command to build Packages and Contents files:</p> <pre><code>apt-ftparchive --arch amd64 packages pool/main &gt; dists/stable/main/binary-amd64/Packages
gzip -k dists/stable/main/binary-amd64/Packages

apt-ftparchive --arch amd64 packages pool/contrib &gt; dists/stable/contrib/binary-amd64/Packages
gzip -k dists/stable/contrib/binary-amd64/Packages

apt-ftparchive --arch amd64 packages pool/non-free &gt; dists/stable/non-free/binary-amd64/Packages
gzip -k dists/stable/non-free/binary-amd64/Packages

apt-ftparchive contents pool/main &gt; dists/stable/main/Contents-amd64
gzip -k dists/stable/main/Contents-amd64

apt-ftparchive contents pool/contrib &gt; dists/stable/contrib/Contents-amd64
gzip -k dists/stable/contrib/Contents-amd64 

apt-ftparchive contents pool/non-free &gt; dists/stable/non-free/Contents-amd64
gzip -k dists/stable/non-free/Contents-amd64

apt-ftparchive release dists/stable/main/binary-amd64 &gt; dists/stable/main/binary-amd64/Release
apt-ftparchive release dists/stable/contrib/binary-amd64 &gt; dists/stable/contrib/binary-amd64/Release
apt-ftparchive release dists/stable/non-free/binary-amd64 &gt; dists/stable/non-free/binary-amd64/Release
apt-ftparchive release -c release.conf dists/stable &gt; dists/stable/Release

# Replace $(id -un) with your desired gpg signing key    

gpg -a --yes --output dists/stable/Release.gpg --local-user $(id -un) --detach-sign dists/stable/Release
gpg -a --yes --clearsign --output dists/stable/InRelease --local-user $(id -un) --detach-sign dists/stable/Release
</code></pre> <h3>APT</h3> <p>Give all files appropriate permissions:</p> <pre><code>find /repository -type f -exec chmod a+r {} \;
find /repository -type d -exec chmod a+rx {} \;
</code></pre> <p>Make your local repository is available to the apt tool:</p> <pre><code># 1) If you have a basic repository
echo "deb file:/repository/amd64 ./" | sudo tee /etc/apt/sources.list.d/local.list &gt; /dev/null

# 2) In case you chose the advanced type
echo "deb file:/repository/amd64 stable main contrib non-free" | sudo tee /etc/apt/sources.list.d/local.list &gt; /dev/null
</code></pre> <p>And also your public signing key should be copied to <code>/etc/apt/trusted.gpg.d</code>:</p> <pre><code>gpg --export $(id -un) | sudo tee /etc/apt/trusted.gpg.d/local.gpg &gt; /dev/null
</code></pre> <p>Then modify the file access modes and update your sources:</p> <pre><code>sudo chmod a+r /etc/apt/sources.list.d/local.list
sudo chmod a+r /etc/apt/trusted.gpg.d/local.gpg
sudo apt-get update
</code></pre> <p>*) My project includes a <a href="https://github.com/manuel-io/debian-install/blob/master/config/includes.chroot/packages/amd64/build.sh">script</a> which can handle the download process of the deb packages.</p> </section> <div style='clear:both;'></div> <footer> <section class="meta"> <p> <span class="byline author vcard">Posted by <span class="fn">Manuel</span></span> </p> <p class='categories'> <a class='category' href='/blog/categories/2017/'>2017</a>, <a class='category' href='/blog/categories/administration/'>administration</a>, <a class='category' href='/blog/categories/bash/'>bash</a>, <a class='category' href='/blog/categories/debian/'>debian</a> </p> </section> <section class='pagination'> <table><tr> <th class='left'><p><a href="/blog/2017/06/03/recipes/" title="Previous Post: Rezepte">&laquo; </a></p></th> <td class='left'><p><a href="/blog/2017/06/03/recipes/" title="Previous Post: Rezepte">Rezepte</a></p></td> <td class='right'><p><a href="/blog/2017/07/22/recent-photography/" title="Next Post: Recent Photography">Recent Photography</a></p></td> <th class='right'><p><a href="/blog/2017/07/22/recent-photography/" title="Next Post: Recent Photography"> &raquo;</a></p></th> </tr></table> </section> </footer> </article> <footer><section class='posts'> <ul> <li><a href="/blog/2019/06/01/minicloud/">1. Minicloud</a></li> <li><a href="/blog/2019/05/05/fortsetzung/">2. Fortsetzung</a></li> <li><a href="/blog/2019/04/14/base2/">3. Base âˆˆ {2, 10}</a></li> <li><a href="/blog/2019/03/02/css-animation-101/">4. CSS Animation 101</a></li> <li><a href="/blog/2019/02/03/driving-batteries-in-parallel/">5. Driving Batteries in Parallel</a></li> </ul> </section> <section class='copyright'> <p> Copyright &copy; 2010-2019 | Manuel | <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> </p> </section> </footer> </body> </html>