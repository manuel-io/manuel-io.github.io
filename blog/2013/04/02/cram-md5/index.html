<!DOCTYPE html> <!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]--> <!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]--> <!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html manifest="cache.manifest" class="no-js" lang="en"><!--<![endif]--> <head> <meta charset="utf-8"> <title>CRAM-MD5 - A personal Blog</title> <meta name="author" content="Manuel"> <meta name="keywords" content="2013, ruby, programming, md5, listing, administration"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="apple-touch-icon" href="/style/touch-icon.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/style/touch-icon.png"> <link rel="canonical" href="https://manuel-io.github.io/blog/2013/04/02/cram-md5"> <link rel="shortcut icon" type="image/png" href="/favicon.png"> <link href="/stylesheets/screen.css" media="all" rel="stylesheet" type="text/css"> <link href="/atom.xml" rel="alternate" title="A personal Blog" type="application/atom+xml"> <script src="/javascripts/libs/jquery-1.11.2.min.js" type="text/javascript"></script> <script src="/javascripts/blog.js" type="text/javascript"></script> <script type="text/javascript" src="/javascripts/mathjax/unpacked/MathJax.js?config=TeX-AMS_HTML"></script> <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "jax": ["input/TeX", "output/HTML-CSS"],
    styles: { ".MathJax_Display": { "text-align": "left" } },
    "tex2jax": {
      inlineMath: [ ['$', '$'], ["\\(", "\\)"] ],
      displayMath: [ ['$$', '$$'], ["\\[", "\\]"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: { autoNumber: "AMS" },
      TagSide: "left"
    },
    "HTML-CSS": {
      availableFonts: ["TeX"],
      linebreaks: { automatic: true }
    }
  });
</script> </head> <body> <header class='site'><h1> <a href="/"> <p>A</p> <p> </p> <p>p</p> <p>e</p> <p>r</p> <p>s</p> <p>o</p> <p>n</p> <p>a</p> <p>l</p> <p> </p> <p>B</p> <p>l</p> <p>o</p> <p>g</p> </a> </h1> </header> <div style='clear:both;'></div> <nav><span><a href="/">Blog</a></span> <span><a href="/blog/photography">Photography</a></span> <span><a href="http://vkitchen.herokuapp.com" target="_blank">Kitchen</a></span> <span><a href="https://minicloud.zahlenpresse.de" target="_blank">Minicloud</a></span> <span><a href="https://github.com/manuel-io" target="_blank">Github</a></span> <span><a href="https://de.wikipedia.org/wiki/Benutzer:Manuel_Bieling" target="_blank">Wikipedia</a></span> <span><a href="/blog/links">Links</a></span> <span><a href="/atom.xml">Feed</a></span> <span><a href="/blog/tags">Tags</a></span> <span><a href="/blog/archives">Archive</a></span> <span><a href="/blog/about">About</a></span> </nav> <article> <header class='post'> <h1 class="entry-title">CRAM-MD5</h1> <p> <time class='entry-date' datetime='2013-04-02T13:20:00+02:00'><span class='date'>Apr, 2013-04-02 | </span> <span class='time'>Tue, 13:20 CEST</span></time> </p> </header> <section><p>Zum Testen der Konfiguration eines Mailservers via <a href='https://de.wikipedia.org/wiki/Mail_Submission_Agent'>Submission</a>, kann <em>openssl</em> verwendet werden:</p> <pre><code>openssl s_client -starttls smtp -connect example.com:587
</code></pre> <p>Bietet der Server die Authentifizierung per <em>CRAM-MD5</em>-Challenge-Response an, kann eine Challenge mit dem <em>AUTH</em>-Befehl angefordert werden. Eine Base64-Dekodierung des empfangenen Strings gibt weitere Informationen.</p> <pre><code>AUTH CRAM-MD5
334 PDQ4Njg0NDM3NDAxNjc2NTguMTM2NDg0NzkxM0BleGFtcGxlLmNvbT4=
</code></pre> <p>Basierend auf der Challenge und dem gemeinsamen Geheimnis—dem Passwort—wird eine Prüfsumme gebildet und über das Netz gesendet:</p> <pre><code>MD5(('secret' XOR omask), MD5(('secret' XOR imask), challenge))
</code></pre> <p>Die Implementierung in <em>Ruby</em> sieht dann etwa so aus:</p> <pre><code>#!/usr/bin/env ruby
require 'base64'
require 'openssl'
require 'io/console'

IMASK = 0x36
OMASK = 0x5c
CRAM_BUFFERSIZE = 64

print 'Username: '
username = gets.chomp
print 'Password: '
secret = STDIN.noecho(&amp;:gets).chomp
print "\n" + 'Challenge: '
base64_challenge = gets.chomp

if base64_challenge =~ /^[a-zA-Z0-9\+\/\=]+$/
  challenge = Base64.decode64 base64_challenge
else raise ArgumentError, 'Challenge is not a valid base64 string.'
end

def cram_md5_response(secret, challenge)
  tmp = Digest::MD5.digest(cram_secret(secret, IMASK) + challenge)
  Digest::MD5.hexdigest(cram_secret(secret, OMASK) + tmp)
end

def cram_secret(secret, mask)
  secret = Digest::MD5.digest(secret) if secret.size &gt; CRAM_BUFFERSIZE
  buffer = secret.ljust CRAM_BUFFERSIZE, "\0"
  0.upto(buffer.size - 1) do |i|
    buffer[i] = (buffer[i].ord ^ mask).chr
  end
  buffer
end

digest = cram_md5_response secret, challenge 

puts 'Method: CRAM-MD5'
puts 'Username: ' + username
puts 'Challenge: ' + challenge
puts 'Response: ' + Base64.encode64("#{username} #{digest}")
</code></pre> </section> <div style='clear:both;'></div> <footer> <section class="meta"> <p> <span class="byline author vcard">Posted by <span class="fn">Manuel</span></span> </p> <p class='categories'> <a class='category' href='/blog/categories/2013/'>2013</a>, <a class='category' href='/blog/categories/administration/'>administration</a>, <a class='category' href='/blog/categories/listing/'>listing</a>, <a class='category' href='/blog/categories/md5/'>md5</a>, <a class='category' href='/blog/categories/programming/'>programming</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a> </p> </section> <section class='pagination'> <table><tr> <th class='left'><p><a href="/blog/2013/04/01/fail2ban/" title="Previous Post: Fail2ban">&laquo; </a></p></th> <td class='left'><p><a href="/blog/2013/04/01/fail2ban/" title="Previous Post: Fail2ban">Fail2ban</a></p></td> <td class='right'><p><a href="/blog/2013/04/11/die-vermessung-der-welt/" title="Next Post: Die Vermessung der Welt">Die Vermessung der Welt</a></p></td> <th class='right'><p><a href="/blog/2013/04/11/die-vermessung-der-welt/" title="Next Post: Die Vermessung der Welt"> &raquo;</a></p></th> </tr></table> </section> </footer> </article> <footer><section class='posts'> <ul> <li><a href="/blog/2020/03/29/query-minidlna-to-list-media-files/">1. Query MiniDLNA to list media files</a></li> <li><a href="/blog/2020/02/21/laugenbrezeln/">2. Laugenbrezeln</a></li> <li><a href="/blog/2020/02/01/recent-work-end-2019/">3. Recent Work (End 2019)</a></li> <li><a href="/blog/2019/10/26/flask-progressive-download-and-large-objects/">4. Flask: Progressive Download &amp; Large Objects</a></li> <li><a href="/blog/2019/08/17/hitchhiker-to-the-climate-summit/">5. Hitchhiking to the climate summit</a></li> </ul> </section> <section class='copyright'> <p> Copyright &copy; 2010-2020 | Manuel | <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> </p> </section> </footer> </body> </html>